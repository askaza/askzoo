/*
 * jQuery Form Styler v1.4.5
 * https://github.com/Dimox/jQueryFormStyler
 *
 * Copyright 2012-2013 Dimox (http://dimox.name/)
 * Released under the MIT license.
 *
 * Date: 2013.11.24
 *
 */

(function($) {
	$.fn.styler = function(opt) {

		var opt = $.extend({
			idSuffix: '-styler',
			filePlaceholder: 'Р¤Р°Р№Р» РЅРµ РІС‹Р±СЂР°РЅ',
			browseText: 'РћР±Р·РѕСЂ...',
			selectVisibleOptions: 0,
			singleSelectzIndex: '100',
			selectSmartPositioning: true
		}, opt);

		return this.each(function() {
			var el = $(this);

			function attributes() {
				var id = '',
						title = '',
						classes = '',
						dataList = '';
				if (el.attr('id') !== undefined && el.attr('id') != '') id = ' id="' + el.attr('id') + opt.idSuffix + '"';
				if (el.attr('title') !== undefined && el.attr('title') != '') title = ' title="' + el.attr('title') + '"';
				if (el.attr('class') !== undefined && el.attr('class') != '') classes = ' ' + el.attr('class');
				var data = el.data();
				for (var i in data) {
					if (data[i] != '') dataList += ' data-' + i + '="' + data[i] + '"';
				}
				id += dataList;
				this.id = id;
				this.title = title;
				this.classes = classes;
			}

			// checkbox
			if (el.is(':checkbox')) {
				el.each(function() {
					if (el.parent('div.jq-checkbox').length < 1) {

						function checkbox() {

							var att = new attributes();
							var checkbox = $('<div' + att.id + ' class="jq-checkbox' + att.classes + '"' + att.title + '><div class="jq-checkbox__div"></div></div>');

							// РїСЂСЏС‡РµРј РѕСЂРёРіРёРЅР°Р»СЊРЅС‹Р№ С‡РµРєР±РѕРєСЃ
							el.css({
								position: 'absolute',
								zIndex: '-1',
								opacity: 0,
								margin: 0,
								padding: 0
							}).after(checkbox).prependTo(checkbox);

							checkbox.attr('unselectable', 'on').css({
								'-webkit-user-select': 'none',
								'-moz-user-select': 'none',
								'-ms-user-select': 'none',
								'-o-user-select': 'none',
								'user-select': 'none',
								display: 'inline-block',
								position: 'relative',
								overflow: 'hidden'
							});

							if (el.is(':checked')) checkbox.addClass('checked');
							if (el.is(':disabled')) checkbox.addClass('disabled');

							// РєР»РёРє РЅР° РїСЃРµРІРґРѕС‡РµРєР±РѕРєСЃ
							checkbox.click(function() {
								if (!checkbox.is('.disabled')) {
									if (el.is(':checked')) {
										el.prop('checked', false);
										checkbox.removeClass('checked');
									} else {
										el.prop('checked', true);
										checkbox.addClass('checked');
									}
									el.change();
									return false;
								} else {
									return false;
								}
							});
							// РєР»РёРє РЅР° label
							el.closest('label').add('label[for="' + el.attr('id') + '"]').click(function(e) {
								checkbox.click();
								e.preventDefault();
							});
							// РїРµСЂРµРєР»СЋС‡РµРЅРёРµ РїРѕ Space РёР»Рё Enter
							el.change(function() {
								if (el.is(':checked')) checkbox.addClass('checked');
								else checkbox.removeClass('checked');
							})
							// С‡С‚РѕР±С‹ РїРµСЂРµРєР»СЋС‡Р°Р»СЃСЏ С‡РµРєР±РѕРєСЃ, РєРѕС‚РѕСЂС‹Р№ РЅР°С…РѕРґРёС‚СЃСЏ РІ С‚РµРіРµ label
							.keydown(function(e) {
								if (e.which == 13 || e.which == 32) checkbox.click();
							})
							.focus(function() {
								if (!checkbox.is('.disabled')) checkbox.addClass('focused');
							})
							.blur(function() {
								checkbox.removeClass('focused');
							})

						} // end checkbox()

						checkbox();

						// РѕР±РЅРѕРІР»РµРЅРёРµ РїСЂРё РґРёРЅР°РјРёС‡РµСЃРєРѕРј РёР·РјРµРЅРµРЅРёРё
						el.on('refresh', function() {
							el.parent().before(el).remove();
							checkbox();
						});

					}
				});
			// end checkbox

			// radio
			} else if (el.is(':radio')) {
				el.each(function() {
					if (el.parent('div.jq-radio').length < 1) {

						function radio() {

							var att = new attributes();
							var radio = $('<div' + att.id + ' class="jq-radio' + att.classes + '"' + att.title + '><div class="jq-radio__div"></div></div>');

							// РїСЂСЏС‡РµРј РѕСЂРёРіРёРЅР°Р»СЊРЅСѓСЋ СЂР°РґРёРѕРєРЅРѕРїРєСѓ
							el.css({
								position: 'absolute',
								zIndex: '-1',
								opacity: 0,
								margin: 0,
								padding: 0
							}).after(radio).prependTo(radio);

							radio.attr('unselectable', 'on').css({
								'-webkit-user-select': 'none',
								'-moz-user-select': 'none',
								'-ms-user-select': 'none',
								'-o-user-select': 'none',
								'user-select': 'none',
								display: 'inline-block',
								position: 'relative'
							});

							if (el.is(':checked')) radio.addClass('checked');
							if (el.is(':disabled')) radio.addClass('disabled');

							// РєР»РёРє РЅР° РїСЃРµРІРґРѕСЂР°РґРёРѕРєРЅРѕРїРєРµ
							radio.click(function() {
								if (!radio.is('.disabled')) {
									radio.closest('form').find('input[name="' + el.attr('name') + '"]').prop('checked', false).parent().removeClass('checked');
									el.prop('checked', true).parent().addClass('checked');
									el.change();
									return false;
								} else {
									return false;
								}
							});
							// РєР»РёРє РЅР° label
							el.closest('label').add('label[for="' + el.attr('id') + '"]').click(function(e) {
								radio.click();
								e.preventDefault();
							});
							// РїРµСЂРµРєР»СЋС‡РµРЅРёРµ СЃС‚СЂРµР»РєР°РјРё
							el.change(function() {
								el.parent().addClass('checked');
							})
							.focus(function() {
								if (!radio.is('.disabled')) radio.addClass('focused');
							})
							.blur(function() {
								radio.removeClass('focused');
							})

						} // end radio()

						radio();

						// РѕР±РЅРѕРІР»РµРЅРёРµ РїСЂРё РґРёРЅР°РјРёС‡РµСЃРєРѕРј РёР·РјРµРЅРµРЅРёРё
						el.on('refresh', function() {
							el.parent().before(el).remove();
							radio();
						});

					}
				});
			// end radio

			// file
			} else if (el.is(':file')) {
				// РїСЂСЏС‡РµРј РѕСЂРёРіРёРЅР°Р»СЊРЅРѕРµ РїРѕР»Рµ
				el.css({
					position: 'absolute',
					top: 0,
					right: 0,
					width: '100%',
					height: '100%',
					opacity: 0,
					margin: 0,
					padding: 0
				}).each(function() {
					if (el.parent('div.jq-file').length < 1) {

						function file() {

							var att = new attributes();
							var file = $('<div' + att.id + ' class="jq-file' + att.classes + '"' + att.title + ' style="display: inline-block; position: relative; overflow: hidden"></div>');
							var name = $('<div class="jq-file__name">' + opt.filePlaceholder + '</div>').appendTo(file);
							var browse = $('<div class="jq-file__browse">' + opt.browseText + '</div>').appendTo(file);
							el.after(file);
							file.append(el);
							if (el.is(':disabled')) file.addClass('disabled');
							el.change(function() {
								name.text(el.val().replace(/.+[\\\/]/, ''));
							})
							.focus(function() {
								file.addClass('focused');
							})
							.blur(function() {
								file.removeClass('focused');
							})
							.click(function() {
								file.removeClass('focused');
							})

						} // end file()

						file();

						// РѕР±РЅРѕРІР»РµРЅРёРµ РїСЂРё РґРёРЅР°РјРёС‡РµСЃРєРѕРј РёР·РјРµРЅРµРЅРёРё
						el.on('refresh', function() {
							el.parent().before(el).remove();
							file();
						})

					}
				});
			// end file

			// select
			} else if (el.is('select')) {
				el.each(function() {
					if (el.next('div.jqselect').length < 1) {

						function selectbox() {

							// Р·Р°РїСЂРµС‰Р°РµРј РїСЂРѕРєСЂСѓС‚РєСѓ СЃС‚СЂР°РЅРёС†С‹ РїСЂРё РїСЂРѕРєСЂСѓС‚РєРµ СЃРµР»РµРєС‚Р°
							function preventScrolling(selector) {
								selector.unbind('mousewheel DOMMouseScroll').bind('mousewheel DOMMouseScroll', function(e) {
									var scrollTo = null;
									if (e.type == 'mousewheel') { scrollTo = (e.originalEvent.wheelDelta * -1); }
									else if (e.type == 'DOMMouseScroll') { scrollTo = 40 * e.originalEvent.detail; }
									if (scrollTo) { e.preventDefault(); $(this).scrollTop(scrollTo + $(this).scrollTop()); }
								});
							}

							var option = $('option', el);
							var list = '';
							// С„РѕСЂРјРёСЂСѓРµРј СЃРїРёСЃРѕРє СЃРµР»РµРєС‚Р°
							function makeList() {
								for (i = 0, len = option.length; i < len; i++) {
									var li = '',
											liClass = '',
											dataList = '',
											optionClass = '',
											optgroupClass = '',
											dataJqfsClass = '';
									var disabled = 'disabled';
									var selDis = 'selected sel disabled';
									if (option.eq(i).prop('selected')) liClass = 'selected sel';
									if (option.eq(i).is(':disabled')) liClass = disabled;
									if (option.eq(i).is(':selected:disabled')) liClass = selDis;
									if (option.eq(i).attr('class') !== undefined) {
										optionClass = ' ' + option.eq(i).attr('class');
										dataJqfsClass = ' data-jqfs-class="' + option.eq(i).attr('class') + '"';
									}

									var data = option.eq(i).data();
									for (var k in data) {
										if (data[k] != '') dataList += ' data-' + k + '="' + data[k] + '"';
									}

									li = '<li' + dataJqfsClass + dataList + ' class="' + liClass + optionClass + '">'+ option.eq(i).text() +'</li>';

									// РµСЃР»Рё РµСЃС‚СЊ optgroup
									if (option.eq(i).parent().is('optgroup')) {
										if (option.eq(i).parent().attr('class') !== undefined) optgroupClass = ' ' + option.eq(i).parent().attr('class');
										li = '<li' + dataJqfsClass + ' class="' + liClass + optionClass + ' option' + optgroupClass + '">'+ option.eq(i).text() +'</li>';
										if (option.eq(i).is(':first-child')) {
											li = '<li class="optgroup' + optgroupClass + '">' + option.eq(i).parent().attr('label') + '</li>' + li;
										}
									}

									list += li;
								}
							} // end makeList()

							// РѕРґРёРЅРѕС‡РЅС‹Р№ СЃРµР»РµРєС‚
							function doSelect() {
								var att = new attributes();
								var selectbox =
									$('<div' + att.id + ' class="jq-selectbox jqselect' + att.classes + '" style="display: inline-block; position: relative; z-index:' + opt.singleSelectzIndex + '">'+
											'<div class="jq-selectbox__select"' + att.title + '>'+
												'<div class="jq-selectbox__select-text"></div>'+
												'<div class="jq-selectbox__trigger"><div class="jq-selectbox__trigger-arrow"></div></div>'+
											'</div>'+
										'</div>');

								// .jq-selectbox-wrapper РЅРµРѕР±С…РѕРґРёРј РґР»СЏ С‚РѕРіРѕ, С‡С‚РѕР±С‹ РёР·Р±Р°РІРёС‚СЊСЃСЏ РѕС‚ РіРѕСЂРёР·РѕРЅС‚Р°Р»СЊРЅРѕР№ РїСЂРѕРєСЂСѓС‚РєРё,
								// РїРѕСЏРІР»СЏРµРјРѕР№, РєРѕРіРґР° С€РёСЂРёРЅР° СЃРµР»РµРєС‚Р° СѓРєР°Р·Р°РЅР° РІ РїСЂРѕС†РµРЅС‚Р°С…
								// РёР·-Р·Р° СЃРІРѕР№СЃС‚РІР° position: absolute Сѓ РѕСЂРёРіРёРЅР°Р»СЊРЅРѕРіРѕ СЃРµР»РµРєС‚Р°
								el.css({margin: 0, padding: 0}).wrap('<div class="jq-selectbox-wrapper" style="display: inline-block; position: relative;"></div>').after(selectbox);

								// РґРµР»Р°РµРј .jq-selectbox-wrapper Р±Р»РѕС‡РЅС‹Рј, РµСЃР»Рё С€РёСЂРёРЅР° РѕСЂРёРіРёРЅР°Р»Р° СѓРєР°Р·Р°РЅР° РІ РїСЂРѕС†РµРЅС‚Р°С…
								var elClone = el.clone().appendTo('body');
								var elCloneWidth = elClone.width();
								elClone.remove();
								if (elCloneWidth != el.width()) {
									el.parent().css('display', 'block');
								}

								var divSelect = $('div.jq-selectbox__select', selectbox);
								var divText = $('div.jq-selectbox__select-text', selectbox);
								var optionSelected = option.filter(':selected');

								// Р±РµСЂРµРј РѕРїС†РёСЋ РїРѕ СѓРјРѕР»С‡Р°РЅРёСЋ
								if (optionSelected.length) {
									divText.text(optionSelected.text());
								} else {
									divText.text(option.first().text());
								}

								makeList();
								var dropdown =
									$('<div class="jq-selectbox__dropdown" style="position: absolute; overflow: auto; overflow-x: hidden">'+
											'<ul style="list-style: none">' + list + '</ul>'+
										'</div>');
								selectbox.append(dropdown);
								var li = $('li', dropdown);

								// РѕРїСЂРµРґРµР»СЏРµРј СЃР°РјС‹Р№ С€РёСЂРѕРєРёР№ РїСѓРЅРєС‚ СЃРµР»РµРєС‚Р°
								var liWidth = 0;
								li.each(function() {
									$(this).css({'display': 'inline-block', 'white-space': 'nowrap'});
									if ($(this).width() > liWidth) liWidth = $(this).width();
									$(this).css({'display': 'block', 'white-space': 'normal'});
								});

								// СЃС‚Р°РІРёРј С€РёСЂРёРЅСѓ РїСЃРµРІРґРѕСЃРµР»РµРєС‚Р° СЂР°РІРЅРѕР№ С€РёСЂРёРЅРµ РѕСЂРёРіРёРЅР°Р»СЊРЅРѕРіРѕ СЃРµР»РµРєС‚Р°
								selectbox.width(el.outerWidth());

								// РµСЃР»Рё С€РёСЂРёРЅР° СЃРµР»РµРєС‚Р° СѓРєР°Р·Р°РЅР°, РЅРѕ РµСЃС‚СЊ РїСѓРЅРєС‚, С€РёСЂРёРЅР° РєРѕС‚РѕСЂРѕРіРѕ Р±РѕР»СЊС€Рµ
								if (liWidth > dropdown.width()) {
									dropdown.width(liWidth + dropdown.width() - li.width());
								}

								// РїСЂСЏС‡РµРј РѕСЂРёРіРёРЅР°Р»СЊРЅС‹Р№ СЃРµР»РµРєС‚
								el.css({
									position: 'absolute',
									opacity: 0,
									height: selectbox.outerHeight()
								});

								var liSelected = li.filter('.selected');
								if (liSelected.length < 1) li.first().addClass('selected sel');
								var selectHeight = selectbox.outerHeight();
								if (dropdown.css('left') == 'auto') dropdown.css({left: 0});
								if (dropdown.css('top') == 'auto') dropdown.css({top: selectHeight});
								var liHeight = li.outerHeight();
								var position = dropdown.css('top');
								dropdown.hide();

								// РµСЃР»Рё РІС‹Р±СЂР°РЅ РЅРµ РґРµС„РѕР»С‚РЅС‹Р№ РїСѓРЅРєС‚
								if (liSelected.length) {
									// РґРѕР±Р°РІР»СЏРµРј РєР»Р°СЃСЃ, РїРѕРєР°Р·С‹РІР°СЋС‰РёР№ РёР·РјРµРЅРµРЅРёРµ СЃРµР»РµРєС‚Р°
									if (option.first().text() != optionSelected.text()) {
										selectbox.addClass('changed');
									}
									// РїРµСЂРµРґР°РµРј СЃРµР»РµРєС‚Сѓ РєР»Р°СЃСЃ РІС‹Р±СЂР°РЅРЅРѕРіРѕ РїСѓРЅРєС‚Р°
									selectbox.data('jqfs-class', liSelected.data('jqfs-class'));
									selectbox.addClass(liSelected.data('jqfs-class'));
								}

								// РµСЃР»Рё СЃРµР»РµРєС‚ РЅРµР°РєС‚РёРІРЅС‹Р№
								if (el.is(':disabled')) {
									selectbox.addClass('disabled');
									return false;
								}

								// РїСЂРё РєР»РёРєРµ РЅР° РїСЃРµРІРґРѕСЃРµР»РµРєС‚Рµ
								divSelect.click(function() {
									el.focus();

									// РµСЃР»Рё iOS, С‚Рѕ РЅРµ РїРѕРєР°Р·С‹РІР°РµРј РІС‹РїР°РґР°СЋС‰РёР№ СЃРїРёСЃРѕРє
									var iOS = navigator.userAgent.match(/(iPad|iPhone|iPod)/g) ? true : false;
									if (iOS) return;

									// СѓРјРЅРѕРµ РїРѕР·РёС†РёРѕРЅРёСЂРѕРІР°РЅРёРµ
									if (opt.selectSmartPositioning) {
										var win = $(window);
										var topOffset = selectbox.offset().top;
										var bottomOffset = win.height() - selectHeight - (topOffset - win.scrollTop());
										var visible = opt.selectVisibleOptions;
										var	minHeight = liHeight * 6;
										var	newHeight = liHeight * visible;
										if (visible > 0 && visible < 6) minHeight =  newHeight;
										// СЂР°СЃРєСЂС‹С‚РёРµ РІРІРµСЂС…
										if (bottomOffset < 0 || bottomOffset < minHeight)	{
											dropdown.height('auto').css({top: 'auto', bottom: position});
											if (dropdown.outerHeight() > topOffset - win.scrollTop() - 20 ) {
												dropdown.height(Math.floor((topOffset - win.scrollTop() - 20) / liHeight) * liHeight);
												if (visible > 0 && visible < 6) {
													if (dropdown.height() > minHeight) dropdown.height(minHeight);
												} else if (visible > 6) {
													if (dropdown.height() > newHeight) dropdown.height(newHeight);
												}
											}
										// СЂР°СЃРєСЂС‹С‚РёРµ РІРЅРёР·
										} else if (bottomOffset > minHeight) {
											dropdown.height('auto').css({bottom: 'auto', top: position});
											if (dropdown.outerHeight() > bottomOffset - 20 ) {
												dropdown.height(Math.floor((bottomOffset - 20) / liHeight) * liHeight);
												if (visible > 0 && visible < 6) {
													if (dropdown.height() > minHeight) dropdown.height(minHeight);
												} else if (visible > 6) {
													if (dropdown.height() > newHeight) dropdown.height(newHeight);
												}
											}
										}
									}

									$('div.jqselect').css({zIndex: (opt.singleSelectzIndex - 1)}).removeClass('opened focused');
									selectbox.css({zIndex: opt.singleSelectzIndex});
									if (dropdown.is(':hidden')) {
										$('div.jq-selectbox__dropdown:visible').hide();
										dropdown.show();
										selectbox.addClass('opened');
									} else {
										dropdown.hide();
										selectbox.removeClass('opened');
									}

									// РїСЂРѕРєСЂСѓС‡РёРІР°РµРј РґРѕ РІС‹Р±СЂР°РЅРЅРѕРіРѕ РїСѓРЅРєС‚Р° РїСЂРё РѕС‚РєСЂС‹С‚РёРё СЃРїРёСЃРєР°
									if (li.filter('.selected').length) {
										dropdown.scrollTop(dropdown.scrollTop() + li.filter('.selected').position().top - dropdown.innerHeight() / 2 + liHeight / 2);
									}

									preventScrolling(dropdown);
									return false;
								});

								// РїСЂРё РЅР°РІРµРґРµРЅРёРё РєСѓСЂСЃРѕСЂР° РЅР° РїСѓРЅРєС‚ СЃРїРёСЃРєР°
								li.hover(function() {
									$(this).siblings().removeClass('selected');
								});
								var selectedText = li.filter('.selected').text();
								var selText = li.filter('.selected').text();

								// РїСЂРё РєР»РёРєРµ РЅР° РїСѓРЅРєС‚ СЃРїРёСЃРєР°
								li.filter(':not(.disabled):not(.optgroup)').click(function() {
									var t = $(this);
									var liText = t.text();
									if (selectedText != liText) {
										var index = t.index();
										if (t.is('.option')) index -= t.prevAll('.optgroup').length;
										t.addClass('selected sel').siblings().removeClass('selected sel');
										option.prop('selected', false).eq(index).prop('selected', true);
										selectedText = liText;
										divText.text(liText);

										// РґРѕР±Р°РІР»СЏРµРј РєР»Р°СЃСЃ, РїРѕРєР°Р·С‹РІР°СЋС‰РёР№ РёР·РјРµРЅРµРЅРёРµ СЃРµР»РµРєС‚Р°
										if (option.first().text() != liText) {
											selectbox.addClass('changed');
										} else {
											selectbox.removeClass('changed');
										}

										// РїРµСЂРµРґР°РµРј СЃРµР»РµРєС‚Сѓ РєР»Р°СЃСЃ РІС‹Р±СЂР°РЅРЅРѕРіРѕ РїСѓРЅРєС‚Р°
										if (selectbox.data('jqfs-class')) selectbox.removeClass(selectbox.data('jqfs-class'));
										selectbox.data('jqfs-class', t.data('jqfs-class'));
										selectbox.addClass(t.data('jqfs-class'));

										el.change();
									}
									dropdown.hide();
									selectbox.removeClass('opened');
								});
								dropdown.mouseout(function() {
									$('li.sel', dropdown).addClass('selected');
								});

								// РёР·РјРµРЅРµРЅРёРµ СЃРµР»РµРєС‚Р°
								el.change(function() {
									divText.text(option.filter(':selected').text());
									li.removeClass('selected sel').not('.optgroup').eq(el[0].selectedIndex).addClass('selected sel');
								})
								.focus(function() {
									selectbox.addClass('focused');
								})
								.blur(function() {
									selectbox.removeClass('focused');
								})
								// РїСЂРѕРєСЂСѓС‚РєРё СЃРїРёСЃРєР° СЃ РєР»Р°РІРёР°С‚СѓСЂС‹
								.bind('keydown keyup', function(e) {
									divText.text(option.filter(':selected').text());
									li.removeClass('selected sel').not('.optgroup').eq(el[0].selectedIndex).addClass('selected sel');
									// РІРІРµСЂС…, РІР»РµРІРѕ, PageUp
									if (e.which == 38 || e.which == 37 || e.which == 33) {
										dropdown.scrollTop(dropdown.scrollTop() + li.filter('.selected').position().top);
									}
									// РІРЅРёР·, РІРїСЂР°РІРѕ, PageDown
									if (e.which == 40 || e.which == 39 || e.which == 34) {
										dropdown.scrollTop(dropdown.scrollTop() + li.filter('.selected').position().top - dropdown.innerHeight() + liHeight);
									}
									if (e.which == 13) {
										dropdown.hide();
									}
								});

								// РїСЂСЏС‡РµРј РІС‹РїР°РґР°СЋС‰РёР№ СЃРїРёСЃРѕРє РїСЂРё РєР»РёРєРµ Р·Р° РїСЂРµРґРµР»Р°РјРё СЃРµР»РµРєС‚Р°
								$(document).on('click', function(e) {
									// e.target.nodeName != 'OPTION' - РґРѕР±Р°РІР»РµРЅРѕ РґР»СЏ РѕР±С…РѕРґР° Р±Р°РіР° РІ РћРїРµСЂРµ
									// (РїСЂРё РёР·РјРµРЅРµРЅРёРё СЃРµР»РµРєС‚Р° СЃ РєР»Р°РІРёР°С‚СѓСЂС‹ СЃСЂР°Р±Р°С‚С‹РІР°РµС‚ СЃРѕР±С‹С‚РёРµ onclick)
									if (!$(e.target).parents().hasClass('jq-selectbox') && e.target.nodeName != 'OPTION') {
										dropdown.hide().find('li.sel').addClass('selected');
										selectbox.removeClass('focused opened');
									}
								});

							} // end doSelect()

							// РјСѓР»СЊС‚РёСЃРµР»РµРєС‚
							function doMultipleSelect() {
								var att = new attributes();
								var selectbox = $('<div' + att.id + ' class="jq-select-multiple jqselect' + att.classes + '"' + att.title + ' style="display: inline-block; position: relative"></div>');

								// .jq-selectbox-wrapper РЅРµРѕР±С…РѕРґРёРј РґР»СЏ С‚РѕРіРѕ, С‡С‚РѕР±С‹ РёР·Р±Р°РІРёС‚СЊСЃСЏ РѕС‚ РіРѕСЂРёР·РѕРЅС‚Р°Р»СЊРЅРѕР№ РїСЂРѕРєСЂСѓС‚РєРё,
								// РїРѕСЏРІР»СЏРµРјРѕР№, РєРѕРіРґР° С€РёСЂРёРЅР° СЃРµР»РµРєС‚Р° СѓРєР°Р·Р°РЅР° РІ РїСЂРѕС†РµРЅС‚Р°С…
								// РёР·-Р·Р° СЃРІРѕР№СЃС‚РІР° position: absolute Сѓ РѕСЂРёРіРёРЅР°Р»СЊРЅРѕРіРѕ СЃРµР»РµРєС‚Р°
								el.css({margin: 0, padding: 0}).wrap('<div class="jq-selectbox-wrapper" style="display: inline-block; position: relative;"></div>').after(selectbox);

								// РґРµР»Р°РµРј .jq-selectbox-wrapper Р±Р»РѕС‡РЅС‹Рј, РµСЃР»Рё С€РёСЂРёРЅР° РѕСЂРёРіРёРЅР°Р»Р° СѓРєР°Р·Р°РЅР° РІ РїСЂРѕС†РµРЅС‚Р°С…
								var elClone = el.clone().appendTo('body');
								var elCloneWidth = elClone.width();
								elClone.remove();
								if (elCloneWidth != el.width()) {
									el.parent().css('display', 'block');
								}

								makeList();
								selectbox.append('<ul style="position: relative">' + list + '</ul>');
								var ul = $('ul', selectbox).css({'overflow-x': 'hidden'});
								var li = $('li', selectbox).attr('unselectable', 'on').css({'-webkit-user-select': 'none', '-moz-user-select': 'none', '-ms-user-select': 'none', '-o-user-select': 'none', 'user-select': 'none', 'white-space': 'nowrap'});
								var size = el.attr('size');
								var ulHeight = ul.outerHeight();
								var liHeight = li.outerHeight();
								if (size !== undefined && size > 0) {
									ul.css({'height': liHeight * size});
								} else {
									ul.css({'height': liHeight * 4});
								}
								if (ulHeight > selectbox.height()) {
									ul.css('overflowY', 'scroll');
									preventScrolling(ul);
									// РїСЂРѕРєСЂСѓС‡РёРІР°РµРј РґРѕ РІС‹Р±СЂР°РЅРЅРѕРіРѕ РїСѓРЅРєС‚Р°
									if (li.filter('.selected').length) {
										ul.scrollTop(ul.scrollTop() + li.filter('.selected').position().top);
									}
								}

								// РµСЃР»Рё СЃРµР»РµРєС‚ РЅРµР°РєС‚РёРІРЅС‹Р№
								if (el.is(':disabled')) {
									selectbox.addClass('disabled');
									option.each(function() {
										if ($(this).is(':selected')) li.eq($(this).index()).addClass('selected');
									});
									// СѓСЃС‚Р°РЅР°РІР»РёРІР°РµРј С€РёСЂРёРЅСѓ РїСЃРµРІРґРѕСЃРµР»РµРєС‚Р°
									selectbox.width(el.outerWidth());
									selectbox.width(selectbox.width() - (selectbox.outerWidth() - selectbox.width()));

									// РїСЂСЏС‡РµРј РѕСЂРёРіРёРЅР°Р»СЊРЅС‹Р№ СЃРµР»РµРєС‚
									el.css({
										position: 'absolute',
										opacity: 0,
										height: selectbox.outerHeight()
									});

								// РµСЃР»Рё СЃРµР»РµРєС‚ Р°РєС‚РёРІРЅС‹Р№
								} else {

									// СѓСЃС‚Р°РЅР°РІР»РёРІР°РµРј С€РёСЂРёРЅСѓ РїСЃРµРІРґРѕСЃРµР»РµРєС‚Р°
									selectbox.width(el.outerWidth());
									selectbox.width(selectbox.width() - (selectbox.outerWidth() - selectbox.width()));

									// РїСЂСЏС‡РµРј РѕСЂРёРіРёРЅР°Р»СЊРЅС‹Р№ СЃРµР»РµРєС‚
									el.css({
										position: 'absolute',
										opacity: 0,
										height: selectbox.outerHeight()
									});

									// РїСЂРё РєР»РёРєРµ РЅР° РїСѓРЅРєС‚ СЃРїРёСЃРєР°
									li.filter(':not(.disabled):not(.optgroup)').click(function(e) {
										el.focus();
										selectbox.removeClass('focused');
										var clkd = $(this);
										if(!e.ctrlKey) clkd.addClass('selected');
										if(!e.shiftKey) clkd.addClass('first');
										if(!e.ctrlKey && !e.shiftKey) clkd.siblings().removeClass('selected first');

										// РІС‹РґРµР»РµРЅРёРµ РїСѓРЅРєС‚РѕРІ РїСЂРё Р·Р°Р¶Р°С‚РѕРј Ctrl
										if(e.ctrlKey) {
											if (clkd.is('.selected')) clkd.removeClass('selected first');
												else clkd.addClass('selected first');
											clkd.siblings().removeClass('first');
										}

										// РІС‹РґРµР»РµРЅРёРµ РїСѓРЅРєС‚РѕРІ РїСЂРё Р·Р°Р¶Р°С‚РѕРј Shift
										if(e.shiftKey) {
											var prev = false,
													next = false;
											clkd.siblings().removeClass('selected').siblings('.first').addClass('selected');
											clkd.prevAll().each(function() {
												if ($(this).is('.first')) prev = true;
											});
											clkd.nextAll().each(function() {
												if ($(this).is('.first')) next = true;
											});
											if (prev) {
												clkd.prevAll().each(function() {
													if ($(this).is('.selected')) return false;
														else $(this).not('.disabled, .optgroup').addClass('selected');
												});
											}
											if (next) {
												clkd.nextAll().each(function() {
													if ($(this).is('.selected')) return false;
														else $(this).not('.disabled, .optgroup').addClass('selected');
												});
											}
											if (li.filter('.selected').length == 1) clkd.addClass('first');
										}

										// РѕС‚РјРµС‡Р°РµРј РІС‹Р±СЂР°РЅРЅС‹Рµ РјС‹С€СЊСЋ
										option.prop('selected', false);
										li.filter('.selected').each(function() {
											var t = $(this);
											var index = t.index();
											if (t.is('.option')) index -= t.prevAll('.optgroup').length;
											option.eq(index).prop('selected', true);
										});
										el.change();

									});

									// РѕС‚РјРµС‡Р°РµРј РІС‹Р±СЂР°РЅРЅС‹Рµ СЃ РєР»Р°РІРёР°С‚СѓСЂС‹
									option.each(function(i) {
										$(this).data('optionIndex', i);
									});
									el.change(function() {
										li.removeClass('selected');
										var arrIndexes = [];
										option.filter(':selected').each(function() {
											arrIndexes.push($(this).data('optionIndex'));
										});
										li.not('.optgroup').filter(function(i) {
											return $.inArray(i, arrIndexes) > -1;
										}).addClass('selected');
									})
									.focus(function() {
										selectbox.addClass('focused');
									})
									.blur(function() {
										selectbox.removeClass('focused');
									});

									// РїСЂРѕРєСЂСѓС‡РёРІР°РµРј СЃ РєР»Р°РІРёР°С‚СѓСЂС‹
									if (ulHeight > selectbox.height()) {
										el.keydown(function(e) {
											// РІРІРµСЂС…, РІР»РµРІРѕ, PageUp
											if (e.which == 38 || e.which == 37 || e.which == 33) {
												ul.scrollTop(ul.scrollTop() + li.filter('.selected').position().top - liHeight);
											}
											// РІРЅРёР·, РІРїСЂР°РІРѕ, PageDown
											if (e.which == 40 || e.which == 39 || e.which == 34) {
												ul.scrollTop(ul.scrollTop() + li.filter('.selected:last').position().top - ul.innerHeight() + liHeight * 2);
											}
										});
									}

								}
							} // end doMultipleSelect()
							if (el.is('[multiple]')) doMultipleSelect(); else doSelect();
						} // end selectbox()

						selectbox();

						// РѕР±РЅРѕРІР»РµРЅРёРµ РїСЂРё РґРёРЅР°РјРёС‡РµСЃРєРѕРј РёР·РјРµРЅРµРЅРёРё
						el.on('refresh', function() {
							el.parent().before(el).remove();
							selectbox();
						});
						// Р°РґР°РїС‚РёРІРЅР°СЏ С€РёСЂРёРЅР°
						el.on('adaptiveWidth', function() {
							el.css({position: 'static'});
							el.next().width(el.outerWidth());
							el.css({position: 'absolute'});
						});
						$(window).on('resize', function () {
							el.trigger('adaptiveWidth');
						});

					}
				});
			// end select

			// reset
			} else if (el.is(':reset')) {
				el.click(function() {
					setTimeout(function() {
						el.closest('form').find('input, select').trigger('refresh');
					}, 1)
				});
			}
			// end reset

		});

	}
})(jQuery);